# 优选IP获取配置文件示例
# 复制此文件为 .env 并根据需要修改配置

# ==================== 数据源配置 ====================
# 优选IP数据源URL
SOURCE_URL=https://cfip.wxgqlfx.fun/

# 来源D：ipdb.api.030101.xyz（支持bestcf和bestproxy）
# 是否启用来源D（默认：true）
SOURCE_D_ENABLED=true

# 是否启用bestproxy（优选反代IP，已有地区信息）（默认：true）
SOURCE_D_ENABLE_BESTPROXY=true

# 是否启用bestcf（Cloudflare优选IP，需要地区检测）（默认：true）
SOURCE_D_ENABLE_BESTCF=true

# ==================== 过滤配置 ====================
# 最大延迟阈值（毫秒），超过此值的节点将被过滤
MAX_LATENCY=100

# 国家过滤列表（逗号分隔的国家代码）
# 常用国家代码: JP(日本), US(美国), SG(新加坡), HK(香港), TW(台湾), KR(韩国)
# 默认: JP,HK,US
FILTER_COUNTRIES=JP,HK,US

# 每个国家查询的IP数量限制（仅适用于来源A）
# 默认: 10
QUERY_LIMIT=10

# ==================== 输出配置 ====================
# 输出文件路径
OUTPUT_FILE=output/optimal-ips.txt

# ==================== GitHub配置 ====================
# GitHub Personal Access Token（用于自动提交）
# 留空则不自动提交到GitHub
# 需要 repo 权限，在 https://github.com/settings/tokens 创建
GITHUB_TOKEN=

# GitHub仓库（格式: username/repo）
GITHUB_REPO=

# GitHub分支
GITHUB_BRANCH=main

# GitHub仓库中的文件路径

# ==================== 订阅项目API配置 ====================
# 订阅项目的Workers URL（例如: https://your-worker.workers.dev）
# 留空则不使用API上传功能
SUBSCRIPTION_API_URL=

# 订阅项目的API路径（UUID或自定义路径，例如: /351c9981-04b6-4103-aa4b-864aa9c91469）
# 留空则不使用API上传功能
SUBSCRIPTION_API_PATH=

# 是否启用API上传功能（true/false）
# 注意: 需要在订阅项目的配置管理页面开启"允许API管理 (ae)"选项
API_UPLOAD_ENABLED=false
GITHUB_FILE_PATH=optimal-ips.txt

# ==================== 请求配置 ====================
# 请求超时时间（秒）
REQUEST_TIMEOUT=30

# 最大重试次数
MAX_RETRIES=3

# ==================== 日志配置 ====================
# 日志级别: DEBUG, INFO, WARNING, ERROR, CRITICAL
LOG_LEVEL=INFO

# 日志文件路径
LOG_FILE=logs/ip_fetcher.log

# ==================== 缓存配置 ====================
# 是否启用IP地理位置缓存
CACHE_ENABLED=true

# 缓存有效期（天）
CACHE_DAYS=30

# ==================== CF-RAY检测配置 ====================
# 用于获取Cloudflare节点真实数据中心位置
# 通过CF-RAY响应头识别节点实际所在的数据中心（如东京、香港、洛杉矶等）

# 是否启用CF-RAY检测（默认：true）
# 启用后：显示真实位置，如 104.16.132.229:443#A-JP-Tokyo
# 禁用后：显示为Anycast，如 104.16.132.229:443#A-CF-Anycast
# 详细说明请参考: CF_RAY_DETECTION.md
CF_RAY_DETECTION_ENABLED=true

# CF-RAY检测超时时间，单位：秒（默认：20）
# 单个IP的检测超时时间
# 推荐值：20秒（确保Cloudflare IP检测成功）
CF_RAY_TIMEOUT=20

# CF-RAY检测最大重试次数（默认：3）
# 检测失败时的自动重试次数
# 推荐值：3次（提高Cloudflare IP检测成功率）
CF_RAY_MAX_RETRIES=3

# Cloudflare IP优先级配置（默认：true）
# 启用后：对于Cloudflare IP，优先使用CF-RAY检测，只有失败时才使用第三方API
# 禁用后：按照常规检测流程（CF-RAY → API → GeoIP）
# 重要：第三方API无法准确检测CF节点位置，只有CF-RAY能获取真实数据中心位置
PREFER_CFRAY_FOR_CF_IPS=true

# ==================== ping0.cc API配置 ====================
# 用于CF-RAY检测失败时的备用地理位置检测方案
# ping0.cc提供基于IP的地理位置查询服务

# 是否启用ping0.cc API（默认：true）
# 启用后：当CF-RAY检测失败时，自动使用ping0.cc API作为备用方案
# 禁用后：CF-RAY失败时直接使用GeoIP数据库结果
PING0CC_ENABLED=true

# ping0.cc API超时时间，单位：秒（默认：5）
# API请求的超时时间
# 推荐值：5秒
PING0CC_TIMEOUT=5

# ==================== 第一阶段优化配置 ====================
# 以下配置已优化，显著提升检测成功率和速度

# CF-RAY检测超时时间，单位：秒（默认：5，已从15秒优化）
# 单个IP的检测超时时间
# 推荐值：5秒（配合重试机制使用）
# 网络良好：3-5秒 | 网络较差：8-10秒
CF_RAY_TIMEOUT=5

# CF-RAY检测最大并发数（默认：20，已从5提高）
# 同时检测多个IP的并发线程数
# 推荐值：20（显著提升批量检测速度）
# 少量IP（<50）：10-15 | 大量IP（>100）：20-30
CF_RAY_MAX_WORKERS=20

# CF-RAY检测最大重试次数（默认：3）
# 检测失败时的自动重试次数
# 推荐值：3次（显著提升成功率）
# 网络稳定：2-3次 | 网络不稳定：3-5次
CF_RAY_MAX_RETRIES=3

# CF-RAY检测重试基础延迟，单位：秒（默认：0.5）
# 使用指数退避策略：第1次重试0.5秒，第2次1秒，第3次2秒
# 推荐值：0.5秒
# 快速重试：0.3-0.5秒 | 稳定重试：0.5-1秒
CF_RAY_RETRY_DELAY=0.5

# ==================== 第二阶段优化配置 ====================
# 性能优化：缓存、连接池和监控功能

# 是否启用CF-RAY检测结果缓存（默认：true）
# 启用后可避免重复检测相同的IP，显著提升性能
# 推荐：启用（true）
CF_RAY_CACHE_ENABLED=true

# 缓存最大条目数（默认：1000）
# 缓存可以存储的最大IP检测结果数量
# 推荐值：1000（适合大多数场景）
# 小规模使用：500-1000 | 大规模使用：2000-5000
CF_RAY_CACHE_SIZE=1000

# 缓存过期时间，单位：秒（默认：3600，即1小时）
# 缓存结果的有效期，过期后需要重新检测
# 推荐值：3600秒（1小时）
# 频繁更新：1800-3600秒 | 稳定环境：7200-14400秒
CF_RAY_CACHE_TTL=3600

# 连接池保持的连接数（默认：10）
# HTTP连接池中保持活跃的连接数量
# 推荐值：10（与并发数匹配）
# 低并发：5-10 | 高并发：15-20
CF_RAY_POOL_CONNECTIONS=10

# 连接池最大大小（默认：20）
# HTTP连接池可以创建的最大连接数
# 推荐值：20（应大于等于并发数）
# 低并发：10-15 | 高并发：20-30
CF_RAY_POOL_MAXSIZE=20

# 是否启用监控统计功能（默认：true）
# 启用后可以查看检测成功率、缓存命中率等统计信息
# 推荐：启用（true）
CF_RAY_MONITOR_ENABLED=true

# ==================== IP检测V2配置 ====================
# 改进的IP地区检测系统配置
# 实现三层检测策略：CF-RAY → 第三方API → GeoIP数据库

# --- 第三方API降级配置 ---
# 是否启用第三方API作为CF-RAY失败时的备选方案（默认：true）
# 启用后：CF-RAY失败时自动使用第三方API查询
# 禁用后：CF-RAY失败时直接使用GeoIP数据库
ENABLE_API_FALLBACK=true

# IPInfo.IO Widget API（主要 - 速度最快0.71s，准确度高，CF识别率80%）
# 优点：速度快，准确度高，提供详细的ISP和ASN信息
# 缺点：无明显缺点
# 推荐：启用（默认：true）
ENABLE_IPINFO_WIDGET=true

# IP-API.COM（备用 - 用户确认准确）
# 优点：信息详细，成功率高（100%），用户确认准确
# 缺点：响应较慢（1.14秒），有限流（45次/分钟）
# 推荐：启用（默认：true）
ENABLE_IPAPI_COM=true

# IPWhois API（备用 - 稳定可靠）
# 优点：稳定可靠，提供详细的地理位置和ISP信息
# 缺点：响应速度中等
# 推荐：启用（默认：true）
ENABLE_IPWHOIS=true

# IP2Location.IO API（辅助）
# 优点：提供详细的地理位置信息
# 缺点：作为辅助API使用
# 推荐：按需启用（默认：false）
ENABLE_IP2LOCATION=false

# --- API超时和重试配置 ---
# 单个API请求超时时间，单位：秒（默认：5）
# 推荐值：3-5秒
API_TIMEOUT=5

# API请求最大重试次数（默认：2）
# 推荐值：1-3次
API_MAX_RETRIES=2

# --- API优先级配置 ---
# 数字越小优先级越高
# IPInfo.IO Widget优先级（默认：1，最高 - 主要API）
API_IPINFO_WIDGET_PRIORITY=1

# IP-API.COM优先级（默认：2 - 备用API）
API_IPAPI_PRIORITY=2

# IPWhois优先级（默认：3 - 备用API）
API_IPWHOIS_PRIORITY=3

# IP2Location优先级（默认：4，最低 - 辅助API）
API_IP2LOCATION_PRIORITY=4

# --- 缓存过期时间配置 ---
# CF-RAY检测结果缓存时间，单位：秒（默认：86400，即24小时）
# CF-RAY结果最准确，可以缓存较长时间
# 推荐值：86400秒（1天）
CACHE_EXPIRE_CFRAY=86400

# 第三方API结果缓存时间，单位：秒（默认：43200，即12小时）
# API结果相对准确，缓存中等时间
# 推荐值：43200秒（12小时）
CACHE_EXPIRE_API=43200

# GeoIP数据库结果缓存时间，单位：秒（默认：604800，即7天）
# GeoIP结果变化较少，可以缓存较长时间
# 推荐值：604800秒（7天）
CACHE_EXPIRE_GEOIP=604800

# --- 失败处理配置 ---
# 失败IP重试延迟，单位：秒（默认：3600，即1小时）
# IP连续失败3次后，在此时间内不再尝试检测
# 推荐值：3600秒（1小时）
FAILURE_RETRY_DELAY=3600

# API禁用阈值（默认：3）
# API连续失败此次数后将被临时禁用
# 推荐值：3次
API_DISABLE_THRESHOLD=3

# API禁用时长，单位：秒（默认：600，即10分钟）
# API被禁用后，在此时间内不会被使用
# 推荐值：600秒（10分钟）
API_DISABLE_DURATION=600

# --- 性能配置 ---
# 检测最大并发数（默认：10）
# 同时检测多个IP的并发线程数
# 推荐值：10-20
# 注意：GitHub Actions环境建议使用较小值（5-10）
DETECTION_MAX_WORKERS=10

# 单个IP总检测超时，单位：秒（默认：10）
# 包含所有检测层的总超时时间
# 推荐值：10-15秒
DETECTION_TIMEOUT=10

# --- 日志配置 ---
# 是否记录详细的检测日志（默认：true）
# 启用后会记录每次检测的详细过程
# 调试时建议启用，生产环境可禁用以减少日志量
LOG_DETECTION_DETAILS=true

# ==================== 配置说明 ====================
#
# 检测流程：
# 1. 检查缓存 → 如果命中则直接返回
# 2. 判断是否为Cloudflare IP
#    - 如果是CF IP：优先使用CF-RAY检测（唯一准确的方法）
#      → CF-RAY失败时才使用第三方API（会记录警告，结果可能不准确）
#    - 如果不是CF IP：先使用第三方API，失败时尝试CF-RAY
# 3. 第三方API → 按优先级轮询
#    - IPInfo.IO Widget（主要）
#    - IP-API.COM（备用）
#    - IPWhois（备用）
#    - IP2Location（辅助）
# 4. GeoIP数据库 → 最后的备选方案
#
# 重要说明：
# - Cloudflare IP的注册地在美国，第三方GeoIP数据库返回的是注册地，不是实际数据中心位置
# - 只有CF-RAY检测能获取Cloudflare节点的真实位置（如日本东京、香港等）
# - 对于CF IP，第三方API可能将日本节点检测为美国，结果不可靠
#
# API优先级说明：
# - IPInfo.IO Widget: 速度最快(0.71s)，CF识别率80%，作为主要API
# - IP-API.COM: 用户确认准确，作为第一备用
# - IPWhois: 稳定可靠，作为第二备用
# - IP2Location: 辅助API，按需启用
#
# 推荐配置组合：
#
# 【快速模式】- 适合快速检测，可能牺牲部分准确性
# CF_RAY_TIMEOUT=3
# API_TIMEOUT=3
# DETECTION_MAX_WORKERS=20
# ENABLE_API_FALLBACK=true
# ENABLE_IPINFO_WIDGET=true
#
# 【稳定模式】- 适合追求高成功率
# CF_RAY_TIMEOUT=5
# API_TIMEOUT=5
# DETECTION_MAX_WORKERS=10
# ENABLE_API_FALLBACK=true
# ENABLE_IPINFO_WIDGET=true
# ENABLE_IPAPI_COM=true
# ENABLE_IPWHOIS=true
#
# 【GitHub Actions模式】- 适合云端环境
# CF_RAY_TIMEOUT=8
# API_TIMEOUT=5
# DETECTION_MAX_WORKERS=5
# ENABLE_API_FALLBACK=true
# ENABLE_IPINFO_WIDGET=true
# ENABLE_IPAPI_COM=true